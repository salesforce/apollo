syntax = "proto3";

option java_multiple_files = true;
option java_package = "com.salesfoce.apollo.consortium.proto";
option java_outer_classname = "ConsortiumProto";
option objc_class_prefix = "Cp";

package apollo.consortium;

service OrderingService { 
    rpc submit (SubmitTransaction) returns (TransactionResult) {}
    rpc vote (Join) returns (JoinResult) {}
}

message Join {
    bytes context = 1;
    ViewMember member = 2;
}

message JoinResult {
    bytes signature = 2;
    ViewMember nextView = 3;
}

message SubmitTransaction {
    bytes context = 1;
    Transaction transaction = 2;
}

message TransactionResult {
}

message CertifiedBlock {
    Block block = 1;
    repeated Certification certifications = 2;
}

message Block {
    bytes headerHash = 1;
    Header header = 2;
    Body body = 3;
}

message Header {
    bytes previous = 1;
    int64 height = 2;
    int64 lastCheckpoint = 3;
    int64 lastReconfig = 4;
    bytes bodyHash = 5;
    bytes nonce = 6;
}

message Body {
    int64 consensusId = 1;
    BodyType type = 2;
    bytes contents = 3;
}

message Certification {
    bytes id = 1;
    bytes signature = 2;
}

enum BodyType {
    GENESIS = 0;
    USER = 1;
    RECONFIGURE = 2;
    CHECKPOINT = 3;
}

message Genesis {
    bytes genesisData = 1;
    Reconfigure initialView = 2;
}

message User {
    repeated Transaction transactions = 1;
    repeated bytes responses = 2;
}

message Reconfigure {
    bytes id = 1;
    int32 checkpointBlocks = 2;
    int32 toleranceLevel = 3;
    repeated ViewMember view = 4;
    repeated Transaction transactions = 5;
}

message JoinTransaction {
    ViewMember member = 1;
    repeated Certification certification = 2;
}

message ViewMember {
    bytes id = 1;
    bytes consensusKey = 2;
    bytes signature = 3;
}

message Checkpoint {
    repeated Transaction transactions = 1;
    repeated bytes responses = 2;
} 

message Transaction {
    bool join = 1;
    bytes source = 2;
    bytes nonce = 3;
    repeated bytes batch = 4;
    bytes signature = 5;
}

enum MessageType {
    BLOCK = 0;
    TRANSACTION = 1;
    PERSIST = 2;
    VALIDATE = 3;
    PROCLAMATION = 4;
}
message ConsortiumMessage {
    MessageType type = 1;
    bytes msg = 2;
}

message Validate {
    bytes id = 1;
    bytes hash = 2;
    bytes signature = 3;
}

message Proclamation {
    int32 regenecy = 1;
    bytes id = 2;
}
    