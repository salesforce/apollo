<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.4.xsd
      http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.5.xsd">

    <changeSet author="hhildebrand" id="thoth-1">
        <sql>create schema if not exists thoth</sql>

        <createTable tableName="pending_coordinates"
            schemaName="thoth">
            <column generationType="ALWAYS" name="id"
                type="IDENTITY">
                <constraints nullable="false"
                    primaryKey="true" primaryKeyName="pending_coordinates_pkey" />
            </column>
            <column name="identifier" type="INT8">
                <constraints nullable="false" />
            </column>
            <column name="digest" type="VARBINARY">
                <constraints nullable="false" />
            </column>
            <column name="sequence_number" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="ilk" type="VARCHAR(3)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <sql>alter table thoth.pending_coordinates add constraint
            pending_coordinates_ilk_validate check (ilk in ('dip', 'drt', 'icp',
            'ixn', 'nan', 'rct', 'vrc', 'rot'))
        </sql>

        <addUniqueConstraint
            columnNames="identifier, digest, sequence_number, ilk"
            tableName="pending_coordinates" schemaName="thoth" />

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="identifier"
            baseTableName="pending_coordinates" baseTableSchemaName="thoth"
            constraintName="pending_coordinates_identifier_fk"
            referencedTableName="identifier" referencedColumnNames="id"
            referencedTableSchemaName="stereotomy" />

        <createTable tableName="pending_event"
            schemaName="thoth">
            <column name="pending_coordinates" type="INT8">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="digest" type="VARBINARY">
                <constraints nullable="false" />
            </column>
            <column name="content" type="VARBINARY">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="pending_coordinates"
            baseTableName="pending_event" baseTableSchemaName="thoth"
            constraintName="pending_event_pending_coordinates_fk"
            referencedTableName="pending_coordinates" referencedColumnNames="id"
            referencedTableSchemaName="thoth" />

        <createTable tableName="witnessed"
            schemaName="thoth">
            <column name="for" type="INT8">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="witness" type="INT">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="signature" type="VARBINARY">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="for"
            baseTableName="witnessed" baseTableSchemaName="thoth"
            constraintName="witnessed_for_fk" referencedTableName="event"
            referencedColumnNames="coordinates"
            referencedTableSchemaName="stereotomy" />

        <createTable tableName="validation"
            schemaName="thoth">
            <column name="for" type="INT8">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="validator" type="INT8">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="signature" type="VARBINARY">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="for"
            baseTableName="validation" baseTableSchemaName="thoth"
            constraintName="validation_for_fk" referencedTableName="event"
            referencedColumnNames="coordinates"
            referencedTableSchemaName="stereotomy" />

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="validator"
            baseTableName="validation" baseTableSchemaName="thoth"
            constraintName="validation_identifier_fk"
            referencedTableName="identifier" referencedColumnNames="id"
            referencedTableSchemaName="stereotomy" />

        <createTable tableName="witnessing"
            schemaName="thoth">
            <column name="identifier" type="INT8">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="label" type="VARCHAR(1024)">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="public_key" type="VARBINARY">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="identifier"
            baseTableName="witnessing" baseTableSchemaName="thoth"
            constraintName="witnessing_identifier_fk"
            referencedTableName="identifier" referencedColumnNames="id"
            referencedTableSchemaName="stereotomy" />

        <addUniqueConstraint
            columnNames="identifier, label, public_key"
            tableName="witnessing" schemaName="thoth" />

        <createIndex indexName="witnessing_public_key_idx"
            schemaName="thoth" tableName="witnessing">
            <column name="public_key" />
        </createIndex>

        <createTable tableName="validating"
            schemaName="thoth">
            <column name="identifier" type="INT8">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="label" type="VARCHAR(1024)">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
        </createTable>

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="identifier"
            baseTableName="validating" baseTableSchemaName="thoth"
            constraintName="validating_identifier_fk"
            referencedTableName="identifier" referencedColumnNames="id"
            referencedTableSchemaName="stereotomy" />

        <addUniqueConstraint
            columnNames="identifier, label"
            tableName="validating" schemaName="thoth" />

    </changeSet>
</databaseChangeLog>