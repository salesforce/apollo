<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.4.xsd
      http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.5.xsd">

    <changeSet author="hhildebrand" id="thoth-1">
        <sql>create schema if not exists thoth</sql>

        <createTable tableName="pending_coordinates"
            schemaName="thoth">
            <column generationType="ALWAYS" name="id"
                type="IDENTITY">
                <constraints nullable="false"
                    primaryKey="true" primaryKeyName="pending_coordinates_pkey" />
            </column>
            <column name="identifier" type="INT8">
                <constraints nullable="false" />
            </column>
            <column name="digest" type="VARBINARY">
                <constraints nullable="false" />
            </column>
            <column name="sequence_number" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="ilk" type="VARCHAR(3)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <sql>alter table thoth.pending_coordinates add constraint
            pending_coordinates_ilk_validate check (ilk in ('dip', 'drt', 'icp',
            'ixn', 'nan', 'rct', 'vrc', 'rot'))
        </sql>

        <addUniqueConstraint
            columnNames="identifier, digest, sequence_number, ilk"
            tableName="pending_coordinates" schemaName="thoth" />

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="identifier"
            baseTableName="pending_coordinates" baseTableSchemaName="thoth"
            constraintName="pending_coordinates_identifier_fk"
            referencedTableName="identifier" referencedColumnNames="id"
            referencedTableSchemaName="stereotomy" />

        <createIndex indexName="pending_coordinates_digest"
            schemaName="thoth" tableName="pending_coordinates">
            <column name="digest" />
        </createIndex>

        <createTable tableName="pending_event"
            schemaName="thoth">
            <column name="pending_coordinates" type="INT8">
                <constraints nullable="false"
                    primaryKey="true" />
            </column>
            <column name="digest" type="VARBINARY">
                <constraints nullable="false" />
            </column>
            <column name="content" type="VARBINARY">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="pending_coordinates"
            baseTableName="pending_event" baseTableSchemaName="thoth"
            constraintName="pending_event_pending_coordinates_fk"
            referencedTableName="pending_coordinates" referencedColumnNames="id"
            referencedTableSchemaName="thoth" />

        <createTable tableName="view"
            schemaName="thoth">
            <column generationType="ALWAYS" name="id"
                type="IDENTITY">
                <constraints nullable="false"
                    primaryKey="true" primaryKeyName="view_pkey" />
            </column>
            <column name="digest" type="VARBINARY">
                <constraints nullable="false" />
            </column>
            <column name="cardinality" type="INT">
                <constraints nullable="false" />
            </column>
            <column name="K" type="SMALLINT">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addUniqueConstraint
            columnNames="digest"
            tableName="view" schemaName="thoth"
            constraintName="unique_digest"/>

        <createTable tableName="view_membership"
            schemaName="thoth">
            <column name="view" type="INT8">
                <constraints nullable="false" />
            </column>
            <column name="ring" type="SMALLINT">
                <constraints nullable="false" />
            </column>
            <column name="digest" type="VARBINARY">
                <constraints nullable="false" />
            </column>
            <column name="identifier" type="INT8">
                <constraints nullable="false" />
            </column>
        </createTable>
        
        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="identifier"
            baseTableName="view_membership" baseTableSchemaName="thoth"
            constraintName="view_membership_identifier_fk"
            referencedTableName="identifier" referencedColumnNames="id"
            referencedTableSchemaName="stereotomy" />
        
        <addForeignKeyConstraint
            onDelete="CASCADE" baseColumnNames="view"
            baseTableName="view_membership" baseTableSchemaName="thoth"
            constraintName="view_membership_view_fk"
            referencedTableName="view" referencedColumnNames="id"
            referencedTableSchemaName="thoth" />

        <addUniqueConstraint
            columnNames="view, ring, digest"
            tableName="view_membership" schemaName="thoth"  constraintName="unique_view_ring_digest"/>

        <createIndex indexName="view_membership_identifier"
            schemaName="thoth" tableName="view_membership">
            <column name="identifier" />
        </createIndex>

    </changeSet>
</databaseChangeLog>